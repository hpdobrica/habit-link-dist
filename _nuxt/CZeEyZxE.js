import{_ as lt}from"./Cpn0SJeD.js";import{m as at,r as L,G as u,q as it,h as ut,o as N,O as ot,w as q,y as rt,P as ct,Q as vt,R as dt,D as mt,E as X,e as j,C as n,c as $,a as r,b as ft,t as E,H as F,d as ht}from"./BGq74tXb.js";import{u as pt}from"./vOtWYwZC.js";import{u as bt}from"./BpQMLT4q.js";import{u as gt}from"./3xxM4jXH.js";import{H as J}from"./CAFlqnyI.js";const P=1e3,K="abort",W="end",Z="progress",tt="start",et="visibilitychange",_t=at({__name:"countdown",props:{autoStart:{type:Boolean,default:!0},emitEvents:{type:Boolean,default:!0},interval:{type:Number,default:1e3,validator:c=>c>=0},now:{type:Function,default:()=>Date.now()},tag:{type:String,default:"div"},time:{type:Number,default:0,validator:c=>c>=0},date:{type:Date,default:null,validator:c=>c.getTime()>=0},transform:{type:Function,default:c=>c},withYears:{type:Boolean,default:!1},allowNegative:{type:Boolean,default:!1}},emits:[K,W,Z,tt],setup(c,{expose:m,emit:M}){const D=60*P,d=60*D,b=24*d,I=365*b,t=c,g=M,i=L(!1),o=L(0),e=L(0),s=L(0),v=u(()=>{var p;return((p=t.date)==null?void 0:p.getTime())-t.now()||t.time}),_=u(()=>t.withYears?Math.floor(e.value/I):0),f=u(()=>t.withYears?Math.floor(e.value%I/b):Math.floor(e.value/b)),O=u(()=>Math.floor(e.value%b/d)),x=u(()=>Math.floor(e.value%d/D)),T=u(()=>Math.floor(e.value%D/P)),H=u(()=>Math.floor(e.value%P)),R=u(()=>t.withYears?f.value+_.value*365:f.value),S=u(()=>Math.floor(e.value/d)),a=u(()=>Math.floor(e.value/D)),w=u(()=>Math.floor(e.value/P));it(()=>{e.value=v.value,o.value=t.now()+v.value,t.autoStart&&y(),document.addEventListener(et,U)}),ut(()=>{document.removeEventListener(et,U),l()});const y=()=>{i.value||(i.value=!0,t.autoStart||(e.value=v.value,o.value=t.now()+v.value),t.emitEvents&&g(tt),document.visibilityState==="visible"&&h())},h=()=>{if(!i.value)return;const p=Math.min(e.value,t.interval);if(t.allowNegative||p>0){let A,V;const z=k=>{A||(A=k),V||(V=k);const Q=k-A;Q>=p||Q+(k-V)/2>=p?C():s.value=requestAnimationFrame(z),V=k};s.value=requestAnimationFrame(z)}else t.allowNegative||(console.log("calling end from continue"),B())},l=()=>{cancelAnimationFrame(s.value)},C=()=>{i.value&&(G(),t.emitEvents&&(t.allowNegative||e.value>0)&&g(Z,{years:_.value,days:f.value,hours:O.value,minutes:x.value,seconds:T.value,milliseconds:H.value,totalDays:R.value,totalHours:S.value,totalMinutes:a.value,totalSeconds:w.value,totalMilliseconds:e.value}),h())},Y=()=>{i.value&&(l(),i.value=!1,t.emitEvents&&g(K))},B=()=>{console.log("countdown ended"),i.value&&(l(),e.value=0,i.value=!1,t.emitEvents&&g(W))},G=()=>{i.value&&(t.allowNegative?e.value=o.value-t.now():e.value=Math.max(0,o.value-t.now()))},st=()=>{l(),e.value=v.value,o.value=t.now()+v.value,i.value=!1,y()},U=()=>{switch(document.visibilityState){case"visible":G(),h();break;case"hidden":l();break}},nt=u(()=>t.transform({years:_.value,days:f.value,hours:O.value,minutes:x.value,seconds:T.value,milliseconds:H.value,totalDays:R.value,totalHours:S.value,totalMinutes:a.value,totalSeconds:w.value,totalMilliseconds:e.value}));return m({start:y,pause:l,abort:Y,end:B,restart:st}),(p,A)=>(N(),ot(dt(c.tag),null,{default:q(()=>[rt(p.$slots,"default",ct(vt(nt.value)))]),_:3}))}}),St={key:0},wt={key:1,class:"page"},yt={class:"top-bar"},Mt={class:"routine-title"},It={class:"timer-section"},Et={class:"timer-icon"},Nt={class:"countdown-timer"},Lt={class:"total-duration"},Dt={key:0,class:"next-habit-title"},Tt={key:1,class:"next-habit-title"},Bt=at({__name:"run",async setup(c){let m,M;const d=mt().params.id;if(typeof d!="string")throw[m,M]=X(()=>F("/")),await m,M(),new Error("wrong routine id");const b=pt(),I=bt(),t=gt(),g=b.routines,i=b.routinesLoading,o=u(()=>g.value[d]??null);j(()=>{!i.value&&!g.value[d]&&F("/")});const e=()=>{v.value=new Date,v.value.setSeconds(v.value.getSeconds()+o.value.habitInstances[s.value].durationSec),_=new Date},s=L(0);let v=L(new Date),_=new Date;j(()=>{!i.value&&o.value&&e()});const f=([m,M]=X(()=>t.createRoutineLog(d)),m=await m,M(),m),O=()=>{const a=Math.abs((new Date().getTime()-_.getTime())/1e3);t.createHabitLog(o.value.habitInstances[s.value].habitId,J.Completed,a,f),s.value++,T(),e()},x=()=>{const a=Math.abs((new Date().getTime()-_.getTime())/1e3);t.createHabitLog(o.value.habitInstances[s.value].habitId,J.Skipped,a,f),s.value++,T(),e()},T=async()=>{console.log(o.value.habitInstances.length,s.value),o.value.habitInstances.length<=s.value&&(console.log("GOOOO"),await F(`/routines/${d}/complete/${f}`))},H=u(()=>!(o.value.habitInstances.length<=s.value+1)),R=S=>{const a={},{totalSeconds:w}=S,y=w<0,h=Math.abs(w),l=Math.floor(h/60),C=h%60,Y=y?`-${l<10?`0${l}`:l}`:l<10?`0${l}`:String(l),B=C<10?`0${C}`:String(C);return a.minutes=Y,a.seconds=B,a};return(S,a)=>{const w=lt,y=_t;return n(i)?(N(),$("div",St,"Loading...")):(N(),$("div",wt,[r("div",yt,[a[1]||(a[1]=r("div",{class:"placeholder"},null,-1)),ft(w,{to:{name:"routines-id",params:{id:n(o).id}},class:"close-button"},{default:q(()=>a[0]||(a[0]=[ht("X")])),_:1},8,["to"])]),r("h1",Mt,E(n(I).habits.value[n(o).habitInstances[n(s)].habitId].title),1),r("div",It,[r("div",Et,E(n(I).habits.value[n(o).habitInstances[n(s)].habitId].icon),1),(N(),ot(y,{date:n(v),transform:R,"allow-negative":!0,key:n(s)},{default:q(({minutes:h,seconds:l})=>[r("div",Nt,E(h)+":"+E(l),1)]),_:1},8,["date"])),r("div",Lt,E(n(o).habitInstances[n(s)].durationSec)+"s",1)]),r("div",{class:"action-buttons"},[a[2]||(a[2]=r("button",{class:"action-button pause-button"},"‚è∏Ô∏è",-1)),r("button",{class:"action-button complete-button",onClick:O},"‚úîÔ∏è"),r("button",{class:"action-button skip-button",onClick:x},"‚è≠Ô∏è")]),n(H)?(N(),$("h3",Dt," Next habit ‚û°Ô∏è "+E(n(I).habits.value[n(o).habitInstances[n(s)+1].habitId].title),1)):(N(),$("h3",Tt,"This is the last one! üèÜ")),a[3]||(a[3]=r("div",{class:"footer"}," Additional details can go here. ",-1))]))}}});export{Bt as default};
