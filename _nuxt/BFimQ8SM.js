import{_ as it}from"./CR7CbRW9.js";import{m as ot,r as D,B as u,q as lt,h as ut,o as C,D as nt,w as J,y as rt,K as ct,aI as dt,L as vt,S as ft,U as P,e as j,J as i,c as q,a as d,b as mt,t as N,V as B,d as ht}from"./SOaKdOla.js";import{H as Q}from"./5hOz_2Hu.js";import{u as gt}from"./Dv4-J59m.js";import{u as bt}from"./mz2PcySp.js";import{u as pt}from"./BrkDYnhR.js";import{a as St}from"./CsW9t2Wp.js";const U=1e3,W="abort",Z="end",tt="progress",et="start",at="visibilitychange",_t=ot({__name:"countdown",props:{autoStart:{type:Boolean,default:!0},emitEvents:{type:Boolean,default:!0},interval:{type:Number,default:1e3,validator:v=>v>=0},now:{type:Function,default:()=>Date.now()},tag:{type:String,default:"div"},time:{type:Number,default:0,validator:v=>v>=0},date:{type:Date,default:null,validator:v=>v.getTime()>=0},transform:{type:Function,default:v=>v},withYears:{type:Boolean,default:!1},allowNegative:{type:Boolean,default:!1}},emits:[W,Z,tt,et],setup(v,{expose:c,emit:h}){const _=60*U,g=60*_,f=24*g,T=365*f,t=v,w=h,o=D(!1),b=D(0),e=D(0),H=D(0),n=u(()=>{var S;return((S=t.date)==null?void 0:S.getTime())-t.now()||t.time}),I=u(()=>t.withYears?Math.floor(e.value/T):0),s=u(()=>t.withYears?Math.floor(e.value%T/f):Math.floor(e.value/f)),y=u(()=>Math.floor(e.value%f/g)),M=u(()=>Math.floor(e.value%g/_)),R=u(()=>Math.floor(e.value%_/U)),G=u(()=>Math.floor(e.value%U)),k=u(()=>t.withYears?s.value+I.value*365:s.value),V=u(()=>Math.floor(e.value/g)),A=u(()=>Math.floor(e.value/_)),$=u(()=>Math.floor(e.value/U));lt(()=>{e.value=n.value,b.value=t.now()+n.value,t.autoStart&&l(),document.addEventListener(at,O)}),ut(()=>{document.removeEventListener(at,O),r()});const l=()=>{o.value||(o.value=!0,t.autoStart||(e.value=n.value,b.value=t.now()+n.value),t.emitEvents&&w(et),document.visibilityState==="visible"&&a())},a=()=>{if(!o.value)return;const S=Math.min(e.value,t.interval);if(t.allowNegative||S>0){let Y,F;const K=x=>{Y||(Y=x),F||(F=x);const X=x-Y;X>=S||X+(x-F)/2>=S?E():H.value=requestAnimationFrame(K),F=x};H.value=requestAnimationFrame(K)}else t.allowNegative||(console.log("calling end from continue"),m())},r=()=>{cancelAnimationFrame(H.value)},E=()=>{o.value&&(L(),t.emitEvents&&(t.allowNegative||e.value>0)&&w(tt,{years:I.value,days:s.value,hours:y.value,minutes:M.value,seconds:R.value,milliseconds:G.value,totalDays:k.value,totalHours:V.value,totalMinutes:A.value,totalSeconds:$.value,totalMilliseconds:e.value}),a())},p=()=>{o.value&&(r(),o.value=!1,t.emitEvents&&w(W))},m=()=>{console.log("countdown ended"),o.value&&(r(),e.value=0,o.value=!1,t.emitEvents&&w(Z))},L=()=>{o.value&&(t.allowNegative?e.value=b.value-t.now():e.value=Math.max(0,b.value-t.now()))},z=()=>{r(),e.value=n.value,b.value=t.now()+n.value,o.value=!1,l()},O=()=>{switch(document.visibilityState){case"visible":L(),a();break;case"hidden":r();break}},st=u(()=>t.transform({years:I.value,days:s.value,hours:y.value,minutes:M.value,seconds:R.value,milliseconds:G.value,totalDays:k.value,totalHours:V.value,totalMinutes:A.value,totalSeconds:$.value,totalMilliseconds:e.value}));return c({start:l,pause:r,abort:p,end:m,restart:z}),(S,Y)=>(C(),nt(vt(v.tag),null,{default:J(()=>[rt(S.$slots,"default",ct(dt(st.value)))]),_:3}))}}),wt=()=>St("run-cache",()=>({})),It={key:0},yt={key:1,class:"page"},Mt={class:"top-bar"},Et={class:"routine-title"},Lt={class:"timer-section"},Nt={class:"timer-icon"},Ct={class:"countdown-timer"},Dt={class:"total-duration"},Tt={class:"action-buttons"},Ht={key:0,class:"next-habit-title"},Rt={key:1,class:"next-habit-title"},Yt=ot({__name:"run",async setup(v){let c,h;const _=ft(),g=_.params.id;if(typeof g!="string")throw[c,h]=P(()=>B("/")),await c,h(),new Error("wrong routine id");const f=_.params.routineLogId;if(typeof f!="string")throw[c,h]=P(()=>B("/")),await c,h(),new Error("wrong routine log id");const T=gt(),t=bt(),w=pt(),o=wt(),b=T.routines,e=T.routinesLoading,H=t.habitsLoading,n=u(()=>b.value[g]??null);j(()=>{!e.value&&!b.value[g]&&B("/")});const I=(l=new Date)=>{n.value.habitInstances[s.value]!=null&&(y.value=new Date(l),y.value.setSeconds(y.value.getSeconds()+n.value.habitInstances[s.value].durationSec),M=new Date(l),o.value={RoutineLogId:f,CurrentIndex:s.value,HabitStart:M})},s=D(0);let y=D(new Date),M=new Date,R=!1;if(j(()=>{!e.value&&n.value&&(o.value.RoutineLogId!=null&&o.value.RoutineLogId!=f&&(o.value={}),o.value.CurrentIndex!=null&&o.value.HabitStart!=null&&R==!1?(R=!0,console.log("setting from cache!"),s.value=o.value.CurrentIndex,I(o.value.HabitStart)):I())}),!([c,h]=P(()=>w.getRoutineLog(f)),c=await c,h(),c))throw[c,h]=P(()=>B("/routines/"+g)),await c,h(),new Error("routine log not found");const k=async l=>{const r=Math.abs((new Date().getTime()-M.getTime())/1e3);w.createHabitLog(n.value.habitInstances[s.value].habitId,l,r,f),await V()||(s.value++,I())},V=async()=>(console.log(n.value.habitInstances.length,s.value),n.value.habitInstances.length<=s.value+1?(o.value={},await B(`/routines/${g}/logs/${f}/complete`),!0):!1),A=u(()=>!(n.value.habitInstances.length<=s.value+1)),$=l=>{const a={},{totalSeconds:r}=l,E=r<0,p=Math.abs(r),m=Math.floor(p/60),L=p%60,z=E?`-${m<10?`0${m}`:m}`:m<10?`0${m}`:String(m),O=L<10?`0${L}`:String(L);return a.minutes=z,a.seconds=O,a};return(l,a)=>{const r=it,E=_t;return i(e)||i(H)?(C(),q("div",It,"Loading...")):(C(),q("div",yt,[d("div",Mt,[a[3]||(a[3]=d("div",{class:"placeholder"},null,-1)),mt(r,{to:{name:"routines-id",params:{id:i(n).id}},class:"close-button"},{default:J(()=>a[2]||(a[2]=[ht("X ")])),_:1},8,["to"])]),d("h1",Et,N(i(t).habits.value[i(n).habitInstances[i(s)].habitId].title),1),d("div",Lt,[d("div",Nt,N(i(t).habits.value[i(n).habitInstances[i(s)].habitId].icon),1),(C(),nt(E,{date:i(y),transform:$,"allow-negative":!0,key:i(s)},{default:J(({minutes:p,seconds:m})=>[d("div",Ct,N(p)+":"+N(m),1)]),_:1},8,["date"])),d("div",Dt,N(i(n).habitInstances[i(s)].durationSec)+"s",1)]),d("div",Tt,[a[4]||(a[4]=d("button",{class:"action-button pause-button"},"‚è∏Ô∏è",-1)),d("button",{class:"action-button complete-button",onClick:a[0]||(a[0]=p=>k(("HabitStatus"in l?l.HabitStatus:i(Q)).Completed))},"‚úîÔ∏è"),d("button",{class:"action-button skip-button",onClick:a[1]||(a[1]=p=>k(("HabitStatus"in l?l.HabitStatus:i(Q)).Skipped))},"‚è≠Ô∏è")]),i(A)?(C(),q("h3",Ht," Next habit ‚û°Ô∏è "+N(i(t).habits.value[i(n).habitInstances[i(s)+1].habitId].title),1)):(C(),q("h3",Rt,"This is the last one! üèÜ")),a[5]||(a[5]=d("div",{class:"footer"}," Additional details can go here. ",-1))]))}}});export{Yt as default};
