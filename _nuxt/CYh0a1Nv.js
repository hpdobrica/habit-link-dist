import{_ as Ue}from"./BLTMpVSx.js";import{a as De}from"./BDfhDb7_.js";import{e as Me,r as D,v as O,i as Ye,g as Fe,B as xe,o as H,y as Ce,w as me,p as $e,G as Ve,aE as je,H as We,n as Te,s as Ke,O as ze,P as ne,C as Ne,E as u,c as G,a as y,b as Ge,t as P,q as qe,m as Qe,Q as q,d as Xe}from"./Dl_kVMvN.js";import{H as ve}from"./Cb9qwsxW.js";import{u as Je}from"./9hteKA1K.js";import{u as Ze,a as en}from"./DhoL68Hh.js";import"./DQI9ee4c.js";const nn=window.setInterval;var te=1,X=2,J=4,Z=8,ee=16,Se=32,oe=64,re=128,Ee=256,ye=512,ge=1024,Ae=re|oe|ee|Z|J|X,S=1e3,w=60,L=60,T=24,we=T*L*w*S,_=7,B=12,U=10,Y=10,F=10,Q=Math.ceil,b=Math.floor;function Re(e,a){var n=e.getTime();return e.setMonth(e.getMonth()+a),Math.round((e.getTime()-n)/we)}function he(e){var a=e.getTime(),n=new Date(a);return n.setMonth(e.getMonth()+1),Math.round((n.getTime()-a)/we)}function an(e){var a=e.getTime(),n=new Date(a);return n.setFullYear(e.getFullYear()+1),Math.round((n.getTime()-a)/we)}function pe(e,a){if(a=a instanceof Date||a!==null&&isFinite(a)?new Date(+a):new Date,!e)return a;var n=+e.value||0;return n?(a.setTime(a.getTime()+n),a):(n=+e.milliseconds||0,n&&a.setMilliseconds(a.getMilliseconds()+n),n=+e.seconds||0,n&&a.setSeconds(a.getSeconds()+n),n=+e.minutes||0,n&&a.setMinutes(a.getMinutes()+n),n=+e.hours||0,n&&a.setHours(a.getHours()+n),n=+e.weeks||0,n&&(n*=_),n+=+e.days||0,n&&a.setDate(a.getDate()+n),n=+e.months||0,n&&a.setMonth(a.getMonth()+n),n=+e.millennia||0,n&&(n*=F),n+=+e.centuries||0,n&&(n*=Y),n+=+e.decades||0,n&&(n*=U),n+=+e.years||0,n&&a.setFullYear(a.getFullYear()+n),a)}var ke=0,tn=1,on=2,rn=3,un=4,ln=5,sn=6,cn=7,fn=8,dn=9,Pe=10,ae,ie,ue,le,se,g,_e;function vn(e,a){return _e(e)+(e===1?ae[a]:ie[a])}var Le;function j(){}j.prototype.toString=function(e){var a=Le(this),n=a.length;if(!n)return e?""+e:se;if(n===1)return a[0];var t=ue+a.pop();return a.join(le)+t};j.prototype.toHTML=function(e,a){e=e||"span";var n=Le(this),t=n.length;if(!t)return a=a||se,a&&"<"+e+">"+a+"</"+e+">";for(var i=0;i<t;i++)n[i]="<"+e+">"+n[i]+"</"+e+">";if(t===1)return n[0];var r=ue+n.pop();return n.join(le)+r};j.prototype.addTo=function(e){return pe(this,e)};Le=function(e){var a=[],n=e.millennia;return n&&a.push(g(n,Pe)),n=e.centuries,n&&a.push(g(n,dn)),n=e.decades,n&&a.push(g(n,fn)),n=e.years,n&&a.push(g(n,cn)),n=e.months,n&&a.push(g(n,sn)),n=e.weeks,n&&a.push(g(n,ln)),n=e.days,n&&a.push(g(n,un)),n=e.hours,n&&a.push(g(n,rn)),n=e.minutes,n&&a.push(g(n,on)),n=e.seconds,n&&a.push(g(n,tn)),n=e.milliseconds,n&&a.push(g(n,ke)),a};function mn(e,a){switch(a){case"seconds":if(e.seconds!==w||isNaN(e.minutes))return;e.minutes++,e.seconds=0;case"minutes":if(e.minutes!==L||isNaN(e.hours))return;e.hours++,e.minutes=0;case"hours":if(e.hours!==T||isNaN(e.days))return;e.days++,e.hours=0;case"days":if(e.days!==_||isNaN(e.weeks))return;e.weeks++,e.days=0;case"weeks":if(e.weeks!==he(e.refMonth)/_||isNaN(e.months))return;e.months++,e.weeks=0;case"months":if(e.months!==B||isNaN(e.years))return;e.years++,e.months=0;case"years":if(e.years!==U||isNaN(e.decades))return;e.decades++,e.years=0;case"decades":if(e.decades!==Y||isNaN(e.centuries))return;e.centuries++,e.decades=0;case"centuries":if(e.centuries!==F||isNaN(e.millennia))return;e.millennia++,e.centuries=0}}function N(e,a,n,t,i,r){return e[n]>=0&&(a+=e[n],delete e[n]),a/=i,a+1<=1?0:e[t]>=0?(e[t]=+(e[t]+a).toFixed(r),mn(e,t),0):a}function hn(e,a){var n=N(e,0,"milliseconds","seconds",S,a);if(n&&(n=N(e,n,"seconds","minutes",w,a),!!n&&(n=N(e,n,"minutes","hours",L,a),!!n&&(n=N(e,n,"hours","days",T,a),!!n&&(n=N(e,n,"days","weeks",_,a),!!n&&(n=N(e,n,"weeks","months",he(e.refMonth)/_,a),!!n&&(n=N(e,n,"months","years",an(e.refMonth)/he(e.refMonth),a),!!n&&(n=N(e,n,"years","decades",U,a),!!n&&(n=N(e,n,"decades","centuries",Y,a),!!n&&(n=N(e,n,"centuries","millennia",F,a),n))))))))))throw new Error("Fractional unit overflow")}function pn(e){var a;for(e.milliseconds<0?(a=Q(-e.milliseconds/S),e.seconds-=a,e.milliseconds+=a*S):e.milliseconds>=S&&(e.seconds+=b(e.milliseconds/S),e.milliseconds%=S),e.seconds<0?(a=Q(-e.seconds/w),e.minutes-=a,e.seconds+=a*w):e.seconds>=w&&(e.minutes+=b(e.seconds/w),e.seconds%=w),e.minutes<0?(a=Q(-e.minutes/L),e.hours-=a,e.minutes+=a*L):e.minutes>=L&&(e.hours+=b(e.minutes/L),e.minutes%=L),e.hours<0?(a=Q(-e.hours/T),e.days-=a,e.hours+=a*T):e.hours>=T&&(e.days+=b(e.hours/T),e.hours%=T);e.days<0;)e.months--,e.days+=Re(e.refMonth,1);e.days>=_&&(e.weeks+=b(e.days/_),e.days%=_),e.months<0?(a=Q(-e.months/B),e.years-=a,e.months+=a*B):e.months>=B&&(e.years+=b(e.months/B),e.months%=B),e.years>=U&&(e.decades+=b(e.years/U),e.years%=U,e.decades>=Y&&(e.centuries+=b(e.decades/Y),e.decades%=Y,e.centuries>=F&&(e.millennia+=b(e.centuries/F),e.centuries%=F)))}function Sn(e,a,n,t){var i=0;!(a&ge)||i>=n?(e.centuries+=e.millennia*F,delete e.millennia):e.millennia&&i++,!(a&ye)||i>=n?(e.decades+=e.centuries*Y,delete e.centuries):e.centuries&&i++,!(a&Ee)||i>=n?(e.years+=e.decades*U,delete e.decades):e.decades&&i++,!(a&re)||i>=n?(e.months+=e.years*B,delete e.years):e.years&&i++,!(a&oe)||i>=n?(e.months&&(e.days+=Re(e.refMonth,e.months)),delete e.months,e.days>=_&&(e.weeks+=b(e.days/_),e.days%=_)):e.months&&i++,!(a&Se)||i>=n?(e.days+=e.weeks*_,delete e.weeks):e.weeks&&i++,!(a&ee)||i>=n?(e.hours+=e.days*T,delete e.days):e.days&&i++,!(a&Z)||i>=n?(e.minutes+=e.hours*L,delete e.hours):e.hours&&i++,!(a&J)||i>=n?(e.seconds+=e.minutes*w,delete e.minutes):e.minutes&&i++,!(a&X)||i>=n?(e.milliseconds+=e.seconds*S,delete e.seconds):e.seconds&&i++,(!(a&te)||i>=n)&&hn(e,t)}function be(e,a,n,t,i,r){var h=new Date;if(e.start=a=a||h,e.end=n=n||h,e.units=t,e.value=n.getTime()-a.getTime(),e.value<0){var c=n;n=a,a=c}e.refMonth=new Date(a.getFullYear(),a.getMonth(),15,12,0,0);try{e.millennia=0,e.centuries=0,e.decades=0,e.years=n.getFullYear()-a.getFullYear(),e.months=n.getMonth()-a.getMonth(),e.weeks=0,e.days=n.getDate()-a.getDate(),e.hours=n.getHours()-a.getHours(),e.minutes=n.getMinutes()-a.getMinutes(),e.seconds=n.getSeconds()-a.getSeconds(),e.milliseconds=n.getMilliseconds()-a.getMilliseconds(),pn(e),Sn(e,t,i,r)}finally{delete e.refMonth}return e}function En(e){return e&te?S/30:e&X?S:e&J?S*w:e&Z?S*w*L:e&ee?S*w*L*T:S*w*L*T*_}function l(e,a,n,t,i){var r;n=+n||Ae,t=t>0?t:NaN,i=i>0?i<20?Math.round(i):20:0;var h=null;typeof e=="function"?(r=e,e=null):e instanceof Date||(e!==null&&isFinite(e)?e=new Date(+e):(typeof h=="object"&&(h=e),e=null));var c=null;if(typeof a=="function"?(r=a,a=null):a instanceof Date||(a!==null&&isFinite(a)?a=new Date(+a):(typeof a=="object"&&(c=a),a=null)),h&&(e=pe(h,a)),c&&(a=pe(c,e)),!e&&!a)return new j;if(!r)return be(new j,e,a,n,t,i);var d=En(n),o,p=function(){r(be(new j,e,a,n,t,i),o)};return p(),o=nn(p,d)}l.MILLISECONDS=te;l.SECONDS=X;l.MINUTES=J;l.HOURS=Z;l.DAYS=ee;l.WEEKS=Se;l.MONTHS=oe;l.YEARS=re;l.DECADES=Ee;l.CENTURIES=ye;l.MILLENNIA=ge;l.DEFAULTS=Ae;l.ALL=ge|ye|Ee|re|oe|Se|ee|Z|J|X|te;var yn=l.setFormat=function(e){if(e){if("singular"in e||"plural"in e){var a=e.singular||[];a.split&&(a=a.split("|"));var n=e.plural||[];n.split&&(n=n.split("|"));for(var t=ke;t<=Pe;t++)ae[t]=a[t]||ae[t],ie[t]=n[t]||ie[t]}typeof e.last=="string"&&(ue=e.last),typeof e.delim=="string"&&(le=e.delim),typeof e.empty=="string"&&(se=e.empty),typeof e.formatNumber=="function"&&(_e=e.formatNumber),typeof e.formatter=="function"&&(g=e.formatter)}},He=l.resetFormat=function(){ae=" millisecond| second| minute| hour| day| week| month| year| decade| century| millennium".split("|"),ie=" milliseconds| seconds| minutes| hours| days| weeks| months| years| decades| centuries| millennia".split("|"),ue=" and ",le=", ",se="",_e=function(e){return e},g=vn};l.setLabels=function(e,a,n,t,i,r,h){yn({singular:e,plural:a,last:n,delim:t,empty:i,formatNumber:r,formatter:h})};l.resetLabels=He;He();const gn=()=>De("timer-cache",()=>({})),wn=Me({__name:"countdown",props:{tag:{type:String,default:"div"},transform:{type:Function,default:e=>e},date:{type:Date,default:null,validator:e=>e.getTime()>=0},timerCacheId:{type:String,default:null},autoStart:{type:Boolean,default:!0},autoComplete:{type:Boolean,default:!1}},emits:["complete"],setup(e,{expose:a,emit:n}){const t=gn(),i=e;let r=null;const h=D({minutes:0,seconds:0}),c=D(Date.now()),d=D(0),o=D(null),p=D(null),E=D(null),W=n,A=D(!1);function v(){E.value!==null&&(r=l(I=>{h.value=I,I.minutes===0&&I.seconds===0&&!A.value&&(A.value=!0,W("complete"))},new Date(E.value),l.MINUTES|l.SECONDS,2))}function R(){o.value||(o.value=Date.now(),r!==null&&(clearInterval(r),r=null),E.value!==null&&(p.value=E.value-Date.now()))}function C(){o.value&&(d.value+=Date.now()-o.value,o.value=null,p.value!==null&&(E.value=Date.now()+p.value,p.value=null,v()))}function s(){o.value?C():R()}const x=O(()=>o.value?o.value-c.value-d.value:Date.now()-c.value-d.value),Ie=O(()=>o.value?d.value+(Date.now()-o.value):d.value),K=O(()=>i.transform({timespan:h.value,activeTime:x.value,pausedTime:Ie.value,pause:R,resume:C,togglePause:s})),ce=O(()=>!!o.value);function fe(){const I=Date.now();let $,z;return o.value?($=o.value-c.value-d.value,z=d.value+(I-o.value)):($=I-c.value-d.value,z=d.value),{activeTime:$,pausedTime:z}}return a({togglePause:s,pause:R,resume:C,getTimerValues:fe,isPaused:ce}),Ye(()=>{t.value.timerCacheId!==i.timerCacheId&&(t.value={timerCacheId:i.timerCacheId,startTime:void 0}),t.value.startTime?(c.value=t.value.startTime,d.value=t.value.pausedTime||d.value,o.value=t.value.pauseStart||o.value,p.value=t.value.remainingMs||p.value,E.value=t.value.endTime||E.value,A.value=t.value.hasEmittedCompletion||A.value,o.value&&p.value!==null?h.value=l(new Date(0),new Date(p.value),l.MINUTES|l.SECONDS,2):v()):(c.value=Date.now(),i.date&&(E.value=i.date.getTime()),v(),i.autoStart||R())}),Fe([c,d,o,p,E],()=>{if(t.value.timerCacheId!==i.timerCacheId){Te(()=>{t.value={timerCacheId:i.timerCacheId}});return}Te(()=>{t.value={timerCacheId:i.timerCacheId,startTime:c.value,pausedTime:d.value,pauseStart:o.value||void 0,remainingMs:p.value||void 0,endTime:E.value||void 0,hasEmittedCompletion:A.value}})},{deep:!0}),xe(()=>{r!==null&&clearInterval(r)}),(I,$)=>(H(),Ce(We(e.tag),null,{default:me(()=>[$e(I.$slots,"default",Ve(je(K.value)))]),_:3}))}}),_n=""+new URL("bell.Bd5O9VeR.mp3",import.meta.url).href,Ln=""+new URL("resonating-bell.jfNfP-9p.mp3",import.meta.url).href,In=Ke({bell:new Audio(_n),resonating_bell:new Audio(Ln)}),Tn=()=>({sounds:In}),Nn=()=>De("routine-run-cache",()=>({})),bn={key:0},Dn={key:1,class:"page"},Mn={class:"top-bar"},Cn={class:"routine-title"},An={class:"timer-section"},Rn={class:"timer-icon"},kn={class:"countdown-timer"},Pn={class:"total-duration"},Hn={class:"action-buttons"},Bn={class:"action-buttons"},On={key:0},Un={key:0,class:"next-habit-title"},Yn={key:1,class:"next-habit-title"},zn=Me({__name:"run",async setup(e){let a,n;const t=ze(),i=t.params.id;if(typeof i!="string")throw[a,n]=ne(()=>q("/")),await a,n(),new Error("wrong routine id");const r=t.params.routineLogId;if(typeof r!="string")throw[a,n]=ne(()=>q("/")),await a,n(),new Error("wrong routine log id");const h=Je(),c=Ze(),d=en(),o=Nn(),p=Tn(),E=h.routines,W=h.routinesLoading,A=c.habitsLoading,v=O(()=>E.value[i]??null);Ne(()=>{!W.value&&!E.value[i]&&(alert("routine not found, about to navigate to home, if this is a mistake try going back and report the issue!"),q("/"))});const R=(f=new Date)=>{v.value.habitInstances[s.value]!=null&&(x.value=new Date(f),x.value.setSeconds(x.value.getSeconds()+v.value.habitInstances[s.value].durationSec),o.value.RoutineLogId=r,o.value.CurrentIndex=s.value)},C=D(null),s=D(0);let x=D(new Date);if(Ne(()=>{!W.value&&v.value&&(o.value.RoutineLogId!=null&&o.value.RoutineLogId!=r&&(o.value={}),o.value.CurrentIndex!=null&&(s.value=o.value.CurrentIndex),R())}),!([a,n]=ne(()=>d.getRoutineLog(r)),a=await a,n(),a))throw[a,n]=ne(()=>q("/routines/"+i)),await a,n(),new Error("routine log not found");const K=async f=>{p.sounds.bell.play();const m=C.value;if(m==null)return;const V=m.getTimerValues();d.createHabitLog(v.value.habitInstances[s.value].habitId,f,V.activeTime/1e3,r),await ce()||(s.value++,R())},ce=async()=>v.value.habitInstances.length<=s.value+1?(o.value={},await q(`/routines/${i}/logs/${r}/complete`),!0):!1,fe=()=>{const f=C.value;f!=null&&f.togglePause()},I=O(()=>{const f=C.value;return f==null?!1:f.isPaused}),$=O(()=>!(v.value.habitInstances.length<=s.value+1)),z=f=>{const m={};let V=!1;f.timespan.value!=null&&(V=f.timespan.value<0);const M=f.timespan.minutes||0,k=f.timespan.seconds||0,de=V?`+${M<10?`0${M}`:M}`:M<10?`0${M}`:String(M),Oe=k<10?`0${k}`:String(k);return m.minutes=de,m.seconds=Oe,m},Be=async()=>{p.sounds.resonating_bell.play(),v.value.habitInstances[s.value].autoComplete&&await K(ve.Completed)};return(f,m)=>{const V=Ue,M=wn;return u(W)||u(A)?(H(),G("div",bn,"Loading...")):(H(),G("div",Dn,[y("div",Mn,[m[3]||(m[3]=y("div",{class:"placeholder"},null,-1)),Ge(V,{to:{name:"routines-id",params:{id:u(v).id}},class:"close-button"},{default:me(()=>m[2]||(m[2]=[Xe("X ")])),_:1},8,["to"])]),y("h1",Cn,P(u(c).habits.value[u(v).habitInstances[u(s)].habitId].title),1),y("div",An,[y("div",Rn,P(u(c).habits.value[u(v).habitInstances[u(s)].habitId].icon),1),(H(),Ce(M,{date:u(x),transform:z,"allow-negative":!0,key:u(s),timerCacheId:u(r)+"-"+u(s),ref_key:"countdownTimer",ref:C,"auto-start":u(v).habitInstances[u(s)].autoStart,onComplete:Be},{default:me(({minutes:k,seconds:de})=>[y("div",kn,P(k)+":"+P(de),1)]),_:1},8,["date","timerCacheId","auto-start"])),y("div",Pn,P(u(v).habitInstances[u(s)].durationSec)+"s",1)]),y("div",Hn,[y("button",{class:qe(["action-button pause-button",{blinking:u(I)}]),onClick:fe},P(u(I)?"▶️":"⏸️"),3),y("button",{class:"action-button complete-button",onClick:m[0]||(m[0]=k=>K(("HabitStatus"in f?f.HabitStatus:u(ve)).Completed))},"✔️"),y("button",{class:"action-button skip-button",onClick:m[1]||(m[1]=k=>K(("HabitStatus"in f?f.HabitStatus:u(ve)).Skipped))},"⏭️")]),y("div",Bn,[u(v).habitInstances[u(s)].autoComplete?(H(),G("h3",On,"will auto-complete ⏩")):Qe("",!0)]),u($)?(H(),G("h3",Un," Next habit ➡️ "+P(u(c).habits.value[u(v).habitInstances[u(s)+1].habitId].title),1)):(H(),G("h3",Yn,"This is the last one! 🏆")),m[4]||(m[4]=y("div",{class:"footer"}," Additional details can go here. ",-1))]))}}});export{zn as default};
