import{_ as Oe}from"./v_d1FPlN.js";import{a as De}from"./oKsZq-NH.js";import{e as Me,r as M,v as G,i as Pe,g as Ye,B as Fe,o as x,y as Ce,w as ve,p as Ue,G as xe,aE as $e,H as Ve,n as Te,O as We,P as J,C as _e,E as u,c as Z,a as I,b as je,t as U,Q as j,d as Ke}from"./Bthc89qw.js";import{H as de}from"./Cb9qwsxW.js";import{u as Ge}from"./C2Dovt5r.js";import{u as ze,a as Qe}from"./9w3Z21wj.js";import"./B6AoZgLS.js";const Xe=window.setInterval;var ae=1,z=2,Q=4,X=8,q=16,pe=32,ie=64,te=128,Ee=256,Se=512,ye=1024,be=te|ie|q|X|Q|z,S=1e3,g=60,L=60,T=24,ge=T*L*g*S,w=7,k=12,H=10,B=10,O=10,K=Math.ceil,D=Math.floor;function Ae(e,a){var n=e.getTime();return e.setMonth(e.getMonth()+a),Math.round((e.getTime()-n)/ge)}function me(e){var a=e.getTime(),n=new Date(a);return n.setMonth(e.getMonth()+1),Math.round((n.getTime()-a)/ge)}function qe(e){var a=e.getTime(),n=new Date(a);return n.setFullYear(e.getFullYear()+1),Math.round((n.getTime()-a)/ge)}function he(e,a){if(a=a instanceof Date||a!==null&&isFinite(a)?new Date(+a):new Date,!e)return a;var n=+e.value||0;return n?(a.setTime(a.getTime()+n),a):(n=+e.milliseconds||0,n&&a.setMilliseconds(a.getMilliseconds()+n),n=+e.seconds||0,n&&a.setSeconds(a.getSeconds()+n),n=+e.minutes||0,n&&a.setMinutes(a.getMinutes()+n),n=+e.hours||0,n&&a.setHours(a.getHours()+n),n=+e.weeks||0,n&&(n*=w),n+=+e.days||0,n&&a.setDate(a.getDate()+n),n=+e.months||0,n&&a.setMonth(a.getMonth()+n),n=+e.millennia||0,n&&(n*=O),n+=+e.centuries||0,n&&(n*=B),n+=+e.decades||0,n&&(n*=H),n+=+e.years||0,n&&a.setFullYear(a.getFullYear()+n),a)}var Re=0,Je=1,Ze=2,en=3,nn=4,an=5,tn=6,on=7,rn=8,un=9,ke=10,ee,ne,oe,re,ue,y,we;function ln(e,a){return we(e)+(e===1?ee[a]:ne[a])}var Ie;function $(){}$.prototype.toString=function(e){var a=Ie(this),n=a.length;if(!n)return e?""+e:ue;if(n===1)return a[0];var t=oe+a.pop();return a.join(re)+t};$.prototype.toHTML=function(e,a){e=e||"span";var n=Ie(this),t=n.length;if(!t)return a=a||ue,a&&"<"+e+">"+a+"</"+e+">";for(var i=0;i<t;i++)n[i]="<"+e+">"+n[i]+"</"+e+">";if(t===1)return n[0];var r=oe+n.pop();return n.join(re)+r};$.prototype.addTo=function(e){return he(this,e)};Ie=function(e){var a=[],n=e.millennia;return n&&a.push(y(n,ke)),n=e.centuries,n&&a.push(y(n,un)),n=e.decades,n&&a.push(y(n,rn)),n=e.years,n&&a.push(y(n,on)),n=e.months,n&&a.push(y(n,tn)),n=e.weeks,n&&a.push(y(n,an)),n=e.days,n&&a.push(y(n,nn)),n=e.hours,n&&a.push(y(n,en)),n=e.minutes,n&&a.push(y(n,Ze)),n=e.seconds,n&&a.push(y(n,Je)),n=e.milliseconds,n&&a.push(y(n,Re)),a};function sn(e,a){switch(a){case"seconds":if(e.seconds!==g||isNaN(e.minutes))return;e.minutes++,e.seconds=0;case"minutes":if(e.minutes!==L||isNaN(e.hours))return;e.hours++,e.minutes=0;case"hours":if(e.hours!==T||isNaN(e.days))return;e.days++,e.hours=0;case"days":if(e.days!==w||isNaN(e.weeks))return;e.weeks++,e.days=0;case"weeks":if(e.weeks!==me(e.refMonth)/w||isNaN(e.months))return;e.months++,e.weeks=0;case"months":if(e.months!==k||isNaN(e.years))return;e.years++,e.months=0;case"years":if(e.years!==H||isNaN(e.decades))return;e.decades++,e.years=0;case"decades":if(e.decades!==B||isNaN(e.centuries))return;e.centuries++,e.decades=0;case"centuries":if(e.centuries!==O||isNaN(e.millennia))return;e.millennia++,e.centuries=0}}function N(e,a,n,t,i,r){return e[n]>=0&&(a+=e[n],delete e[n]),a/=i,a+1<=1?0:e[t]>=0?(e[t]=+(e[t]+a).toFixed(r),sn(e,t),0):a}function cn(e,a){var n=N(e,0,"milliseconds","seconds",S,a);if(n&&(n=N(e,n,"seconds","minutes",g,a),!!n&&(n=N(e,n,"minutes","hours",L,a),!!n&&(n=N(e,n,"hours","days",T,a),!!n&&(n=N(e,n,"days","weeks",w,a),!!n&&(n=N(e,n,"weeks","months",me(e.refMonth)/w,a),!!n&&(n=N(e,n,"months","years",qe(e.refMonth)/me(e.refMonth),a),!!n&&(n=N(e,n,"years","decades",H,a),!!n&&(n=N(e,n,"decades","centuries",B,a),!!n&&(n=N(e,n,"centuries","millennia",O,a),n))))))))))throw new Error("Fractional unit overflow")}function fn(e){var a;for(e.milliseconds<0?(a=K(-e.milliseconds/S),e.seconds-=a,e.milliseconds+=a*S):e.milliseconds>=S&&(e.seconds+=D(e.milliseconds/S),e.milliseconds%=S),e.seconds<0?(a=K(-e.seconds/g),e.minutes-=a,e.seconds+=a*g):e.seconds>=g&&(e.minutes+=D(e.seconds/g),e.seconds%=g),e.minutes<0?(a=K(-e.minutes/L),e.hours-=a,e.minutes+=a*L):e.minutes>=L&&(e.hours+=D(e.minutes/L),e.minutes%=L),e.hours<0?(a=K(-e.hours/T),e.days-=a,e.hours+=a*T):e.hours>=T&&(e.days+=D(e.hours/T),e.hours%=T);e.days<0;)e.months--,e.days+=Ae(e.refMonth,1);e.days>=w&&(e.weeks+=D(e.days/w),e.days%=w),e.months<0?(a=K(-e.months/k),e.years-=a,e.months+=a*k):e.months>=k&&(e.years+=D(e.months/k),e.months%=k),e.years>=H&&(e.decades+=D(e.years/H),e.years%=H,e.decades>=B&&(e.centuries+=D(e.decades/B),e.decades%=B,e.centuries>=O&&(e.millennia+=D(e.centuries/O),e.centuries%=O)))}function dn(e,a,n,t){var i=0;!(a&ye)||i>=n?(e.centuries+=e.millennia*O,delete e.millennia):e.millennia&&i++,!(a&Se)||i>=n?(e.decades+=e.centuries*B,delete e.centuries):e.centuries&&i++,!(a&Ee)||i>=n?(e.years+=e.decades*H,delete e.decades):e.decades&&i++,!(a&te)||i>=n?(e.months+=e.years*k,delete e.years):e.years&&i++,!(a&ie)||i>=n?(e.months&&(e.days+=Ae(e.refMonth,e.months)),delete e.months,e.days>=w&&(e.weeks+=D(e.days/w),e.days%=w)):e.months&&i++,!(a&pe)||i>=n?(e.days+=e.weeks*w,delete e.weeks):e.weeks&&i++,!(a&q)||i>=n?(e.hours+=e.days*T,delete e.days):e.days&&i++,!(a&X)||i>=n?(e.minutes+=e.hours*L,delete e.hours):e.hours&&i++,!(a&Q)||i>=n?(e.seconds+=e.minutes*g,delete e.minutes):e.minutes&&i++,!(a&z)||i>=n?(e.milliseconds+=e.seconds*S,delete e.seconds):e.seconds&&i++,(!(a&ae)||i>=n)&&cn(e,t)}function Ne(e,a,n,t,i,r){var m=new Date;if(e.start=a=a||m,e.end=n=n||m,e.units=t,e.value=n.getTime()-a.getTime(),e.value<0){var c=n;n=a,a=c}e.refMonth=new Date(a.getFullYear(),a.getMonth(),15,12,0,0);try{e.millennia=0,e.centuries=0,e.decades=0,e.years=n.getFullYear()-a.getFullYear(),e.months=n.getMonth()-a.getMonth(),e.weeks=0,e.days=n.getDate()-a.getDate(),e.hours=n.getHours()-a.getHours(),e.minutes=n.getMinutes()-a.getMinutes(),e.seconds=n.getSeconds()-a.getSeconds(),e.milliseconds=n.getMilliseconds()-a.getMilliseconds(),fn(e),dn(e,t,i,r)}finally{delete e.refMonth}return e}function vn(e){return e&ae?S/30:e&z?S:e&Q?S*g:e&X?S*g*L:e&q?S*g*L*T:S*g*L*T*w}function l(e,a,n,t,i){var r;n=+n||be,t=t>0?t:NaN,i=i>0?i<20?Math.round(i):20:0;var m=null;typeof e=="function"?(r=e,e=null):e instanceof Date||(e!==null&&isFinite(e)?e=new Date(+e):(typeof m=="object"&&(m=e),e=null));var c=null;if(typeof a=="function"?(r=a,a=null):a instanceof Date||(a!==null&&isFinite(a)?a=new Date(+a):(typeof a=="object"&&(c=a),a=null)),m&&(e=he(m,a)),c&&(a=he(c,e)),!e&&!a)return new $;if(!r)return Ne(new $,e,a,n,t,i);var d=vn(n),o,h=function(){r(Ne(new $,e,a,n,t,i),o)};return h(),o=Xe(h,d)}l.MILLISECONDS=ae;l.SECONDS=z;l.MINUTES=Q;l.HOURS=X;l.DAYS=q;l.WEEKS=pe;l.MONTHS=ie;l.YEARS=te;l.DECADES=Ee;l.CENTURIES=Se;l.MILLENNIA=ye;l.DEFAULTS=be;l.ALL=ye|Se|Ee|te|ie|pe|q|X|Q|z|ae;var mn=l.setFormat=function(e){if(e){if("singular"in e||"plural"in e){var a=e.singular||[];a.split&&(a=a.split("|"));var n=e.plural||[];n.split&&(n=n.split("|"));for(var t=Re;t<=ke;t++)ee[t]=a[t]||ee[t],ne[t]=n[t]||ne[t]}typeof e.last=="string"&&(oe=e.last),typeof e.delim=="string"&&(re=e.delim),typeof e.empty=="string"&&(ue=e.empty),typeof e.formatNumber=="function"&&(we=e.formatNumber),typeof e.formatter=="function"&&(y=e.formatter)}},He=l.resetFormat=function(){ee=" millisecond| second| minute| hour| day| week| month| year| decade| century| millennium".split("|"),ne=" milliseconds| seconds| minutes| hours| days| weeks| months| years| decades| centuries| millennia".split("|"),oe=" and ",re=", ",ue="",we=function(e){return e},y=ln};l.setLabels=function(e,a,n,t,i,r,m){mn({singular:e,plural:a,last:n,delim:t,empty:i,formatNumber:r,formatter:m})};l.resetLabels=He;He();const hn=()=>De("timer-cache",()=>({})),pn=Me({__name:"countdown",props:{tag:{type:String,default:"div"},transform:{type:Function,default:e=>e},date:{type:Date,default:null,validator:e=>e.getTime()>=0},timerCacheId:{type:String,default:null},autoStart:{type:Boolean,default:!0},autoComplete:{type:Boolean,default:!1}},emits:["complete"],setup(e,{expose:a,emit:n}){const t=hn(),i=e;let r=null;const m=M({minutes:0,seconds:0}),c=M(Date.now()),d=M(0),o=M(null),h=M(null),E=M(null),le=n,f=M(!1);function P(){E.value!==null&&(r=l(_=>{m.value=_,_.minutes===0&&_.seconds===0&&!f.value&&(f.value=!0,le("complete"))},new Date(E.value),l.MINUTES|l.SECONDS,2))}function b(){o.value||(o.value=Date.now(),r!==null&&(clearInterval(r),r=null),E.value!==null&&(h.value=E.value-Date.now()))}function s(){o.value&&(d.value+=Date.now()-o.value,o.value=null,h.value!==null&&(E.value=Date.now()+h.value,h.value=null,P()))}function A(){o.value?s():b()}const Le=G(()=>o.value?o.value-c.value-d.value:Date.now()-c.value-d.value),V=G(()=>o.value?d.value+(Date.now()-o.value):d.value),se=G(()=>i.transform({timespan:m.value,activeTime:Le.value,pausedTime:V.value,pause:b,resume:s,togglePause:A}));function ce(){const _=Date.now();let Y,W;return o.value?(Y=o.value-c.value-d.value,W=d.value+(_-o.value)):(Y=_-c.value-d.value,W=d.value),{activeTime:Y,pausedTime:W}}return a({togglePause:A,pause:b,resume:s,getTimerValues:ce}),Pe(()=>{t.value.timerCacheId!==i.timerCacheId&&(t.value={timerCacheId:i.timerCacheId,startTime:void 0}),t.value.startTime?(c.value=t.value.startTime,d.value=t.value.pausedTime||d.value,o.value=t.value.pauseStart||o.value,h.value=t.value.remainingMs||h.value,E.value=t.value.endTime||E.value,f.value=t.value.hasEmittedCompletion||f.value,o.value&&h.value!==null?m.value=l(new Date(0),new Date(h.value),l.MINUTES|l.SECONDS,2):P()):(c.value=Date.now(),i.date&&(E.value=i.date.getTime()),P(),i.autoStart||b())}),Ye([c,d,o,h,E],()=>{if(t.value.timerCacheId!==i.timerCacheId){Te(()=>{t.value={timerCacheId:i.timerCacheId}});return}Te(()=>{t.value={timerCacheId:i.timerCacheId,startTime:c.value,pausedTime:d.value,pauseStart:o.value||void 0,remainingMs:h.value||void 0,endTime:E.value||void 0,hasEmittedCompletion:f.value}})},{deep:!0}),Fe(()=>{r!==null&&clearInterval(r)}),(_,Y)=>(x(),Ce(Ve(e.tag),null,{default:ve(()=>[Ue(_.$slots,"default",xe($e(se.value)))]),_:3}))}}),En=()=>De("routine-run-cache",()=>({})),Sn={key:0},yn={key:1,class:"page"},gn={class:"top-bar"},wn={class:"routine-title"},In={class:"timer-section"},Ln={class:"timer-icon"},Tn={class:"countdown-timer"},_n={class:"total-duration"},Nn={class:"action-buttons"},Dn={key:0,class:"next-habit-title"},Mn={key:1,class:"next-habit-title"},On=Me({__name:"run",async setup(e){let a,n;const t=We(),i=t.params.id;if(typeof i!="string")throw[a,n]=J(()=>j("/")),await a,n(),new Error("wrong routine id");const r=t.params.routineLogId;if(typeof r!="string")throw[a,n]=J(()=>j("/")),await a,n(),new Error("wrong routine log id");const m=Ge(),c=ze(),d=Qe(),o=En(),h=m.routines,E=m.routinesLoading,le=c.habitsLoading,f=G(()=>h.value[i]??null);_e(()=>{!E.value&&!h.value[i]&&(alert("routine not found, about to navigate to home, if this is a mistake try going back and report the issue!"),j("/"))});const P=(p=new Date)=>{f.value.habitInstances[s.value]!=null&&(A.value=new Date(p),A.value.setSeconds(A.value.getSeconds()+f.value.habitInstances[s.value].durationSec),o.value.RoutineLogId=r,o.value.CurrentIndex=s.value)},b=M(null),s=M(0);let A=M(new Date);if(_e(()=>{!E.value&&f.value&&(o.value.RoutineLogId!=null&&o.value.RoutineLogId!=r&&(o.value={}),o.value.CurrentIndex!=null&&(s.value=o.value.CurrentIndex),P())}),!([a,n]=J(()=>d.getRoutineLog(r)),a=await a,n(),a))throw[a,n]=J(()=>j("/routines/"+i)),await a,n(),new Error("routine log not found");const V=async p=>{const v=b.value;if(v==null)return;const F=v.getTimerValues();d.createHabitLog(f.value.habitInstances[s.value].habitId,p,F.activeTime/1e3,r),await se()||(s.value++,P())},se=async()=>f.value.habitInstances.length<=s.value+1?(o.value={},await j(`/routines/${i}/logs/${r}/complete`),!0):!1,ce=()=>{const p=b.value;p!=null&&p.togglePause()},_=G(()=>!(f.value.habitInstances.length<=s.value+1)),Y=p=>{const v={};let F=!1;p.timespan.value!=null&&(F=p.timespan.value<0);const C=p.timespan.minutes||0,R=p.timespan.seconds||0,fe=F?`+${C<10?`0${C}`:C}`:C<10?`0${C}`:String(C),Be=R<10?`0${R}`:String(R);return v.minutes=fe,v.seconds=Be,v},W=async()=>{f.value.habitInstances[s.value].autoComplete&&await V(de.Completed)};return(p,v)=>{const F=Oe,C=pn;return u(E)||u(le)?(x(),Z("div",Sn,"Loading...")):(x(),Z("div",yn,[I("div",gn,[v[3]||(v[3]=I("div",{class:"placeholder"},null,-1)),je(F,{to:{name:"routines-id",params:{id:u(f).id}},class:"close-button"},{default:ve(()=>v[2]||(v[2]=[Ke("X ")])),_:1},8,["to"])]),I("h1",wn,U(u(c).habits.value[u(f).habitInstances[u(s)].habitId].title),1),I("div",In,[I("div",Ln,U(u(c).habits.value[u(f).habitInstances[u(s)].habitId].icon),1),(x(),Ce(C,{date:u(A),transform:Y,"allow-negative":!0,key:u(s),timerCacheId:u(r)+"-"+u(s),ref_key:"countdownTimer",ref:b,"auto-start":u(f).habitInstances[u(s)].autoStart,onComplete:W},{default:ve(({minutes:R,seconds:fe})=>[I("div",Tn,U(R)+":"+U(fe),1)]),_:1},8,["date","timerCacheId","auto-start"])),I("div",_n,U(u(f).habitInstances[u(s)].durationSec)+"s",1)]),I("div",Nn,[I("button",{class:"action-button pause-button",onClick:ce},"⏸️"),I("button",{class:"action-button complete-button",onClick:v[0]||(v[0]=R=>V(("HabitStatus"in p?p.HabitStatus:u(de)).Completed))},"✔️"),I("button",{class:"action-button skip-button",onClick:v[1]||(v[1]=R=>V(("HabitStatus"in p?p.HabitStatus:u(de)).Skipped))},"⏭️")]),u(_)?(x(),Z("h3",Dn," Next habit ➡️ "+U(u(c).habits.value[u(f).habitInstances[u(s)+1].habitId].title),1)):(x(),Z("h3",Mn,"This is the last one! 🏆")),v[4]||(v[4]=I("div",{class:"footer"}," Additional details can go here. ",-1))]))}}});export{On as default};
